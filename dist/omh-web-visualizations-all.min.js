!function(e,t){var a="OMHWebVisualizations";e[a]=t(e,a),e[a].QUANTIZE_YEAR=6,e[a].QUANTIZE_MONTH=5,e[a].QUANTIZE_DAY=4,e[a].QUANTIZE_HOUR=3,e[a].QUANTIZE_MINUTE=2,e[a].QUANTIZE_SECOND=1,e[a].QUANTIZE_MILLISECOND=0,e[a].QUANTIZE_NONE=-1}(this,function(e,t){var a=e.hasOwnProperty(t)?e[t]:{};return a.Chart=function(e,t,a,n){function o(e,t){function a(a){if(void 0==n[a]){var i=e[a],r=t[a];typeof i==typeof r&&"object"==typeof i?n[a]=o(i||{},r||{}):(n[a]=i,void 0!=r&&(n[a]=r))}}var n={};for(var i in e)a(i);for(var i in t)a(i);return n}var i=864e5,r=.5,s="1px",l="1px";t.node||(t=d3.select(t)),n||(n={});var u=null;t.classed("omh-chart-container",!0);var m=null,d=a.split(/\s*,\s*/),c={},h={},f=null,v=null,p={userInterface:{toolbar:{enabled:!0},timespanButtons:{enabled:!0},zoomButtons:{enabled:!0},navigation:{enabled:!0},tooltips:{enabled:!0,timeFormat:"M/D/YY, h:mma"},panZoom:{enabled:!0,showHint:!0}},measures:{body_weight:{valueKeyPath:"body.body_weight.value",range:{min:0,max:100},units:"kg",thresholds:{max:57}},heart_rate:{valueKeyPath:"body.heart_rate.value",range:{min:30,max:150},units:"bpm"},step_count:{valueKeyPath:"body.step_count",range:{min:0,max:1500},units:"Steps",seriesName:"Steps",timeQuantizationLevel:OMHWebVisualizations.QUANTIZE_DAY,chart:{type:"clustered_bar",barColor:"#eeeeee",daysShownOnTimeline:{min:7,max:90}}},minutes_moderate_activity:{valueKeyPath:"body.minutes_moderate_activity.value",range:{min:0,max:300},units:"Minutes",seriesName:"Minutes of moderate activity",timeQuantizationLevel:OMHWebVisualizations.QUANTIZE_DAY,chart:{type:"clustered_bar",daysShownOnTimeline:{min:7,max:90}}},systolic_blood_pressure:{valueKeyPath:"body.systolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:120}},diastolic_blood_pressure:{valueKeyPath:"body.diastolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:80}}}},b={range:{min:0,max:100},units:"Units",seriesName:"Series",timeQuantizationLevel:OMHWebVisualizations.QUANTIZE_NONE,chart:{type:"line",pointSize:9,lineColor:"#dedede",pointFillColor:"#4a90e2",pointStrokeColor:"#0066d6",aboveThesholdPointFillColor:"#e8ac4e",aboveThesholdPointStrokeColor:"#745628",barColor:"#4a90e2",daysShownOnTimeline:{min:1,max:1e3}}};this.getComponents=function(){var e={};e[d[0]]=E;var t={};t[d[0]]=I;var a={};a[d[0]]=A;var n={};n[d[0]]=w;var o={};o[d[0]]=N;var i={};return i[d[0]]=R,V.forEach(function(n){e[n.measure]=n.scale,t[n.measure]=n.axis,a[n.measure]=n.label}),{xScales:n,yScales:e,colorScales:i,gridlines:null,legends:[Y],xAxes:o,yAxes:t,plots:S,yLabels:a,table:f,tooltip:Se,toolbar:fe,panZoomInteractions:{plotGroup:oe,xAxis:ie}}},this.getD3Selection=function(){return u};var y=o(p,n);d3.keys(y.measures).forEach(function(e){y.measures[e]=o(b,y.measures[e])});var g=y.userInterface,x=function(e){return y.measures[e]},_={},D=function(e,t){if(void 0==e)return e;var a;"string"==typeof t?(_[t]||(_[t]=t.split(".")),a=_[t].slice()):a=t;try{if(t&&a.length>0)return D(e[a.shift()],a)}catch(n){}return e};this.getIntervalDisplayDate=function(e,t,a){var n,o=e.body.effective_time_frame.time_interval,i=o.start_date_time?new Date(o.start_date_time).getTime():null,r=o.end_date_time?new Date(o.end_date_time).getTime():null,s=o.start_date_time?t(o.start_date_time):null,l=o.end_date_time?t(o.end_date_time):null,u={ps:1e-9,ns:1e-6,us:.001,ms:1,sec:1e3,min:6e4,h:36e5,d:"d",wk:"w",Mo:"M",yr:"y"},m=o.duration.unit,d=o.duration.value,c=u[m];"string"!=typeof c?(n=d*c,i||(i=r-d),r||(r=i+d)):(i||(i=l.subtract(d,u[m]).valueOf()),r||(r=s.add(d,u[m]).valueOf()),n=r-i);var h=new Date(i),f=a<=OMHWebVisualizations.QUANTIZE_MONTH?h.getMonth():6,v=a<=OMHWebVisualizations.QUANTIZE_DAY?h.getDate():a===OMHWebVisualizations.QUANTIZE_MONTH?15:1,p=a<=OMHWebVisualizations.QUANTIZE_HOUR?h.getHours():a===OMHWebVisualizations.QUANTIZE_DAY?12:0,b=a<=OMHWebVisualizations.QUANTIZE_MINUTE?h.getMinutes():a===OMHWebVisualizations.QUANTIZE_HOUR?30:0,y=a<=OMHWebVisualizations.QUANTIZE_SECOND?h.getSeconds():a===OMHWebVisualizations.QUANTIZE_MINUTE?30:0,g=a<=OMHWebVisualizations.QUANTIZE_MILLISECOND?h.getMilliseconds():a===OMHWebVisualizations.QUANTIZE_SECOND?500:0,x=new Date(h.getFullYear(),f,v,p,b,y,g);return x},this.parseOmhData=function(e,t,a){var n={},o=this;return e.forEach(function(e){t.forEach(function(t,i){var r=x(t).valueKeyPath,s=D(e,r);if(void 0!==s&&"object"!=typeof s){e.groupName+="_"+t,n.hasOwnProperty(t)||(n[t]=[]);var l;if(e.body.effective_time_frame.date_time&&(l=new Date(e.body.effective_time_frame.date_time)),e.body.effective_time_frame.time_interval){var u=x(t).timeQuantizationLevel;l=o.getIntervalDisplayDate(e,a,u)}var m=x(t).valueKeyPath,d=D(e,m);n[t].push({y:d,x:l,provider:e.header.acquisition_provenance.source_name,omhDatum:e,hasTooltip:0==i,measure:t})}})}),n},m=this.parseOmhData(e,d,moment),this.consolidateData=function(e){e.sort(function(e,t){return e.x.getTime()-t.x.getTime()});for(var t=0;t<e.length;t++)for(;t+1<e.length&&e[t+1].x.getTime()===e[t].x.getTime();)e[t].y+=e[t+1].y,e[t].accumulatedDataBodies||(e[t].accumulatedDataBodies=[e[t].omhDatum.body]),e[t].accumulatedDataBodies.push(e[t+1].omhDatum.body),e.splice(t+1,1)},m.minutes_moderate_activity&&this.consolidateData(m.minutes_moderate_activity),m.step_count&&this.consolidateData(m.step_count);var T=x(d[0]),w=new Plottable.Scales.Time,E=new Plottable.Scales.Linear,P=T.range;E.domainMin(P.min).domainMax(P.max);var N=new Plottable.Axes.Time(w,"bottom").margin(15).addClass("x-axis"),I=new Plottable.Axes.Numeric(E,"left"),A=new Plottable.Components.AxisLabel(T.units,"0").padding(5).xAlignment("right").yAlignment("top"),C=new Plottable.Interactions.Drag,M=function(){q&&q(),Se&&Ie&&Ie()};C.onDrag(M);var O=function(){Ie&&Ie(),he&&he(),q&&q()},S=[],Z=[],U=function(e){var t=x(e.measure).thresholds;return t&&e.y>t.max},z=function(e){var t=x(e.measure).chart;return U(e)?t.aboveThesholdPointFillColor:t.pointFillColor},H=function(e){var t=x(e.measure).chart;return U(e)?t.aboveThesholdPointStrokeColor:t.pointStrokeColor},k=function(e){return x(e.measure).chart.barColor},Q=(new Plottable.Plots.Scatter).x(function(e){return e.x},w).y(function(e){return e.y},E).size(function(e){return x(e.measure).chart.pointSize}).attr("fill",function(e){return z(e)}).attr("opacity",r).attr("stroke-width",l).attr("stroke",function(e){return H(e)}),L=[],W=0,V=[];d3.entries(m).forEach(function(t){measure=t.key,e=t.value,"clustered_bar"===x(measure).chart.type&&W++}),d.forEach(function(t){if(m.hasOwnProperty(t)){e=m[t];var a=new Plottable.Dataset(e),n=x(t);if(a.measure=t,"clustered_bar"===n.chart.type){var o=E;if(L.length>0){var i=n.range,r=n.units;o=(new Plottable.Scales.Linear).domainMin(i.min).domainMax(i.max);var l=new Plottable.Axes.Numeric(o,"right"),u=new Plottable.Components.AxisLabel(r,"0").padding(5).xAlignment("left").yAlignment("top");V.push({measure:t,axis:l,label:u,scale:o})}var d=(new Plottable.Plots.ClusteredBar).x(function(e){return e.x},w).y(function(e){return e.y},o).attr("fill",function(e){return k(e)});L.push(d);for(var c=0;W>c;c++)c===L.length-1?d.addDataset(a):d.addDataset(new Plottable.Dataset([]));var h=N.axisConfigurations(),f=[];h.forEach(function(e){("day"===e[0].interval||"month"===e[0].interval||"year"===e[0].interval)&&f.push(e)}),N.axisConfigurations(f),S.push(d)}else{var v=(new Plottable.Plots.Line).x(function(e){return e.x},w).y(function(e){return e.y},E).attr("stroke",n.chart.lineColor).attr("stroke-width",s);v.addDataset(a),Q.addDataset(a),S.push(v)}}});var B=(new Plottable.Scales.Linear).domainMin(0).domainMax(1),F=(new Plottable.Plots.Line).x(function(e){return e.x},B).y(function(e){return e.y},E).attr("stroke","#dedede").attr("stroke-width",s);d3.entries(m).forEach(function(t){measure=t.key,e=t.value;var a=x(measure).thresholds;a&&F.addDataset(new Plottable.Dataset([{x:0,y:a.max},{x:1,y:a.max}]))}),S.push(F),S.push(Q);var R=null,Y=null;if(W>0){R=new Plottable.Scales.Color,Y=new Plottable.Components.Legend(R);var K=[],G=[];d3.entries(m).forEach(function(t){measure=t.key,e=t.value;var a=x(measure),n=a.seriesName,o=a.chart.barColor;n&&o&&(K.push(n),G.push(o))}),R.domain(K),R.range(G),Y.maxEntriesPerRow(2),Y.symbol(Plottable.SymbolFactories.square),Y.xAlignment("right"),Y.yAlignment("top"),S.push(Y)}if(g.panZoom.enabled&&g.panZoom.showHint){var j=new Plottable.Components.Label("( Drag chart to pan, pinch or scroll to zoom )",0).padding(10).yAlignment("bottom").xAlignment("right").addClass("zoom-hint-label"),q=((new Plottable.Interactions.Click).attachTo(j).onClick(function(e){q()}),function(){j.addClass("hidden")});S.push(j)}var X=new Plottable.Components.Group(S),J=new Plottable.Components.Group([I,A]),$=[J,X],ee=[null,N];V.forEach(function(e){$.push(new Plottable.Components.Group([e.axis,e.label])),ee.push(null)}),f=new Plottable.Components.Table([$,ee]),f.yAlignment("bottom"),C.attachTo(f);var te=T.chart.daysShownOnTimeline,ae=te.min,ne=te.max,oe=null,ie=null;if(g.panZoom.enabled&&(oe=new Plottable.Interactions.PanZoom,oe.addXScale(w),oe.attachTo(X),ie=new Plottable.Interactions.PanZoom,ie.addXScale(w),ie.attachTo(N),ae&&(oe.minDomainExtent(w,ae*i),ie.minDomainExtent(w,ae*i)),ne&&(oe.maxDomainExtent(w,ne*i),ie.maxDomainExtent(w,ne*i))),ne){var re=[];d3.entries(m).forEach(function(t){measure=t.key,e=t.value,e.forEach(function(e){re.push(e.x)})});var se=w.extentOfValues(re),le=se[1].getTime()-se[0].getTime(),ue=ne*i;le>ue&&(se[1]=new Date(se[0].getTime()+ue)),w.domain(se)}var me=function(e){var t=T.chart.daysShownOnTimeline,a=t.min,n=t.max;a&&(e=Math.max(e,a)),n&&(e=Math.min(e,n));var o=w.domain(),r=[o[0],new Date(o[0].getTime()+e*i)];w.domain(r)},de=function(e){var t=T.chart.daysShownOnTimeline,a=t.min,n=t.max,o=w.domain();timeInDays=(o[1].getTime()-o[0].getTime())/i,timeInDays*=(100-e)/100,a&&(timeInDays=Math.max(timeInDays,a)),n&&(timeInDays=Math.min(timeInDays,n));var r=[o[0],new Date(o[0].getTime()+timeInDays*i)];w.domain(r)},ce=function(e){var t=w.domain();timeInDays=(t[1].getTime()-t[0].getTime())/i,timeInDays*=e/100;var a=[new Date(t[0].getTime()+timeInDays*i),new Date(t[1].getTime()+timeInDays*i)];w.domain(a)},he=function(){d3.select(".time-button").classed("active",!1)},fe=null;if(g.toolbar.enabled){if(fe=t.append("div").classed("omh-chart-toolbar",!0).attr("unselectable","on"),g.timespanButtons.enabled){var ve={"1wk":7,"1m":30,"3m":90,"6m":180};fe.append("span").classed("time-buttons-label",!0).text("Show: "),d3.entries(ve).forEach(function(e){var t=e.value,a=e.key;if(ne>=t&&t>=ae){var n=fe.append("span").classed("time-button",!0).text(a);n.on("click",function(){he(),me(t),d3.select(this).classed("active",!0)})}})}if(g.zoomButtons.enabled){var pe={"&#8722;":-20,"&#43;":20};fe.append("span").classed("zoom-buttons-label",!0).text(" Zoom: "),d3.entries(pe).forEach(function(e){var t=e.value,a=e.key,n=fe.append("span").classed("zoom-button",!0).html(a);n.on("click",function(){he(),de(t)})})}if(g.navigation.enabled){var be=fe.append("span",":first-child").classed("previous-time-period-button",!0).text("< prev");be.on("click",function(){ce(-100)});var ye=fe.append("span").classed("next-time-period-button",!0).text("next >");ye.on("click",function(){ce(100)})}}var ge=Q.datasets(),xe=ge&&ge.length>0;if(g.tooltips.enabled&&xe){var _e=null,De=function(e){e.selection.style("opacity","1")},Te=function(e){e.selection.style("opacity",r)},we=function(e,t){h[e][t].forEach(function(e){De(e)})},Ee=function(e,t){h[e][t].forEach(function(e){Te(e)})},Pe=function(e){Se.show(e.datum,e.selection[0][0])},Ne=function(e){e&&u&&(e.selection[0][0].getBoundingClientRect().left>u[0][0].getBoundingClientRect().left&&e.selection[0][0].getBoundingClientRect().right<u[0][0].getBoundingClientRect().right?Pe(e):Se.hide())},Ie=function(){if(_e&&u)if(_e.datum.hasTooltip)Ne(_e);else{var e=c[_e.datum.omhDatum.groupName][_e.index],t=d3.select(".d3-tip").node().clientHeight;Ne(e.selection[0][0].getBoundingClientRect().top>u[0][0].getBoundingClientRect().top+t?e:_e)}},Ae=function(e){null!==_e?e.datum.omhDatum.body!==_e.datum.omhDatum.body&&(Ee(_e.datum.omhDatum.groupName,_e.index),_e=e,we(_e.datum.omhDatum.groupName,e.index)):_e=e,null===e.datum},Ce=new Plottable.Interactions.Pointer;Ce.onPointerExit(function(e){Se.hide()}),Ce.onPointerEnter(Ie.bind(this));var Me=function(e){var t;try{t=Q.entityNearest(e)}catch(a){return}Ae(t),Ie()}.bind(this);Ce.onPointerMove(Me),Ce.attachTo(Q);var Oe=function(e,t){var a,n="value";if(U(e)&&(n+=" above-threshold"),"_systolic_blood_pressure_diastolic_blood_pressure"===e.omhDatum.groupName){var o=e.omhDatum.body.systolic_blood_pressure.value.toFixed(0),i=e.omhDatum.body.diastolic_blood_pressure.value.toFixed(0);a='<div class="'+n+'">'+o+"/"+i+"</div>"}else a="_heart_rate"===e.omhDatum.groupName?'<div class="'+n+'">'+e.y.toFixed(0)+"</div>":'<div class="'+n+'">'+e.y.toFixed(1)+"</div>";var r=g.tooltips.timeFormat;return a+='<div class="time">'+moment(e.x).format(r)+"</div>",a+='<div class="provider">'+e.provider+"</div>"},Se=d3.tip().attr("class","d3-tip").html(function(e){return'<div class="omh-tooltip">'+Oe(e,a)+"</div>"})}this.destroy=function(){Ce&&Ce.offPointerMove(Me),Ce&&Ce.detachFrom(Q),C.detachFrom(f),f.destroy(),Se&&Se.destroy(),v&&v.offWheel(O),Ie&&C.offDrag(Ie),fe&&fe.remove(),Z.forEach(function(e){e()})},this.renderTo=function(e){u=d3.select(e),Se&&u.call(Se),v&&v.offWheel(O),v=new Plottable.Dispatchers.Mouse.getDispatcher(u[0][0]).onWheel(O),f.renderTo(u),c={},h={},Q.entities().forEach(function(e){var t=e.datum.omhDatum.groupName;c[t]||(c[t]=[]),e.datum.hasTooltip&&(c[t][e.index]=e),h[t]||(h[t]=[]),h[t][e.index]||(h[t][e.index]=[]),h[t][e.index].push(e)})}},a});