!function(e,t){var a="OMHWebVisualizations";e[a]=t(e,a)}(this,function(e,t){var a=e.hasOwnProperty(t)?e[t]:{};return a.Chart=function(e,t,a,n){var i=864e5,o=.5,r="1px",s="1px";this.QUANTIZE_YEAR=6,this.QUANTIZE_MONTH=5,this.QUANTIZE_DAY=4,this.QUANTIZE_HOUR=3,this.QUANTIZE_MINUTE=2,this.QUANTIZE_SECOND=1,this.QUANTIZE_MILLISECOND=0,this.QUANTIZE_NONE=-1,t.jquery||(t=$(t)),n||(n={});var l=d3.select(t.find("svg")[0]);t.addClass("omh-chart-container");var u=null,m=a.split(/\s*,\s*/),d={},c={},h=null,p={userInterface:{toolbar:{enabled:!0},timespanButtons:{enabled:!0},zoomButtons:{enabled:!0},navigation:{enabled:!0},tooltips:{enabled:!0,timeFormat:"M/D/YY, h:mma"},panZoom:{enabled:!0,showHint:!0}},measures:{body_weight:{valueKeyPath:"body.body_weight.value",range:{min:0,max:100},units:"kg",thresholds:{max:57}},heart_rate:{valueKeyPath:"body.heart_rate.value",range:{min:30,max:150},units:"bpm"},step_count:{valueKeyPath:"body.step_count",range:{min:0,max:1500},units:"Steps",seriesName:"Steps",timeQuantizationLevel:this.QUANTIZE_DAY,chart:{type:"clustered_bar",barColor:"#eeeeee",daysShownOnTimeline:{min:7,max:90}}},minutes_moderate_activity:{valueKeyPath:"body.minutes_moderate_activity.value",range:{min:0,max:300},units:"Minutes",seriesName:"Minutes of moderate activity",timeQuantizationLevel:this.QUANTIZE_DAY,chart:{type:"clustered_bar",daysShownOnTimeline:{min:7,max:90}}},systolic_blood_pressure:{valueKeyPath:"body.systolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:120}},diastolic_blood_pressure:{valueKeyPath:"body.diastolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:80}}}},v={range:{min:0,max:100},units:"Units",seriesName:"Series",timeQuantizationLevel:this.QUANTIZE_NONE,chart:{type:"line",pointSize:9,lineColor:"#dedede",pointFillColor:"#4a90e2",pointStrokeColor:"#0066d6",aboveThesholdPointFillColor:"#e8ac4e",aboveThesholdPointStrokeColor:"#745628",barColor:"#4a90e2",daysShownOnTimeline:{min:1,max:1e3}}};this.getComponents=function(){var e={};e[m[0]]=T;var t={};t[m[0]]=P;var a={};a[m[0]]=N;var n={};n[m[0]]=x;var i={};i[m[0]]=D;var o={};return o[m[0]]=F,$.each(L,function(n,i){e[i.measure]=i.scale,t[i.measure]=i.axis,a[i.measure]=i.label}),{xScales:n,yScales:e,colorScales:o,gridlines:null,legends:[H],xAxes:i,yAxes:t,plots:A,yLabels:a,table:h,tooltip:Se,toolbar:de,panZoomInteractions:{plotGroup:te,xAxis:ae}}},this.getD3Selection=function(){return l};var f=$.extend(!0,{},p,n);$.each(Object.keys(f.measures),function(e,t){f.measures[t]=$.extend(!0,{},v,f.measures[t])});var b=f.userInterface,y=function(e){return f.measures[e]},g=function(e,t){var a=t.split(".");return t&&a.length>0?g(e[a.shift()],a.join(".")):e};this.getIntervalDisplayDate=function(e,t,a){var n,i=e.body.effective_time_frame.time_interval,o=i.start_date_time?new Date(i.start_date_time).getTime():null,r=i.end_date_time?new Date(i.end_date_time).getTime():null,s=i.start_date_time?t(i.start_date_time):null,l=i.end_date_time?t(i.end_date_time):null,u={ps:1e-9,ns:1e-6,us:.001,ms:1,sec:1e3,min:6e4,h:36e5,d:"d",wk:"w",Mo:"M",yr:"y"},m=i.duration.unit,d=i.duration.value,c=u[m];"string"!=typeof c?(n=d*c,o||(o=r-d),r||(r=o+d)):(o||(o=l.subtract(d,u[m]).valueOf()),r||(r=s.add(d,u[m]).valueOf()),n=r-o);var h=new Date(o),p=a<=this.QUANTIZE_MONTH?h.getMonth():6,v=a<=this.QUANTIZE_DAY?h.getDate():a===this.QUANTIZE_MONTH?15:1,f=a<=this.QUANTIZE_HOUR?h.getHours():a===this.QUANTIZE_DAY?12:0,b=a<=this.QUANTIZE_MINUTE?h.getMinutes():a===this.QUANTIZE_HOUR?30:0,y=a<=this.QUANTIZE_SECOND?h.getSeconds():a===this.QUANTIZE_MINUTE?30:0,g=a<=this.QUANTIZE_MILLISECOND?h.getMilliseconds():a===this.QUANTIZE_SECOND?500:0,_=new Date(h.getFullYear(),p,v,f,b,y,g);return _},this.parseOmhData=function(e,t,a){var n={},i=this;return $.each(e,function(e,o){$.each(t,function(e,r){if(n.hasOwnProperty(r)||(n[r]=[]),o.body.hasOwnProperty(r)){var s=o.omhChartGroupName?o.omhChartGroupName:"",l=!s;s||($.each(t,function(e,t){o.body.hasOwnProperty(t)&&(s+="_"+t)}),o.omhChartGroupName=s);var u;if(o.body.effective_time_frame.date_time&&(u=new Date(o.body.effective_time_frame.date_time)),o.body.effective_time_frame.time_interval){var m=y(r).timeQuantizationLevel;u=i.getIntervalDisplayDate(o,a,m)}var d=y(r).valueKeyPath,c=g(o,d);n[r].push({y:c,x:u,provider:o.header.acquisition_provenance.source_name,body:o.body,groupName:s,hasTooltip:l,measure:r})}})}),n},u=this.parseOmhData(e,m,moment),this.consolidateData=function(e){e.sort(function(e,t){return e.x.getTime()-t.x.getTime()});for(var t=0;t<e.length;t++)for(;t+1<e.length&&e[t+1].x.getTime()===e[t].x.getTime();)e[t].y+=e[t+1].y,e[t].accumulatedDataBodies||(e[t].accumulatedDataBodies=[e[t].body]),e[t].accumulatedDataBodies.push(e[t+1].body),e.splice(t+1,1)},u.minutes_moderate_activity&&this.consolidateData(u.minutes_moderate_activity),u.step_count&&this.consolidateData(u.step_count);var _=y(m[0]),x=new Plottable.Scales.Time,T=new Plottable.Scales.Linear,w=_.range;T.domainMin(w.min).domainMax(w.max);var D=new Plottable.Axes.Time(x,"bottom").margin(15).addClass("x-axis"),P=new Plottable.Axes.Numeric(T,"left"),N=new Plottable.Components.AxisLabel(_.units,"0").padding(5).xAlignment("right").yAlignment("top"),C=new Plottable.Interactions.Drag;C.onDrag(function(){K&&K(),Ne&&Ne()});var I=new Plottable.Dispatchers.Mouse(l[0][0]).onWheel(function(){Ne&&Ne(),me&&me(),K&&K()}),A=[],E=[],S=function(e){var t=y(e.measure).thresholds;return t&&e.y>t.max},M=function(e){var t=y(e.measure).chart;return S(e)?t.aboveThesholdPointFillColor:t.pointFillColor},O=function(e){var t=y(e.measure).chart;return S(e)?t.aboveThesholdPointStrokeColor:t.pointStrokeColor},Z=function(e){return y(e.measure).chart.barColor},U=(new Plottable.Plots.Scatter).x(function(e){return e.x},x).y(function(e){return e.y},T).size(function(e){return y(e.measure).chart.pointSize}).attr("fill",function(e){return M(e)}).attr("opacity",o).attr("stroke-width",s).attr("stroke",function(e){return O(e)}),Q=[],k=0,L=[];$.each(u,function(e,t){"clustered_bar"===_.chart.type&&k++}),$.each(u,function(e,t){var a=new Plottable.Dataset(t),n=y(e);if(a.measure=e,"clustered_bar"===n.chart.type){var i=T;if(Q.length>0){var o=n.range,s=n.units;i=(new Plottable.Scales.Linear).domainMin(o.min).domainMax(o.max);var l=new Plottable.Axes.Numeric(i,"right"),u=new Plottable.Components.AxisLabel(s,"0").padding(5).xAlignment("left").yAlignment("top");L.push({measure:e,axis:l,label:u,scale:i})}var m=(new Plottable.Plots.ClusteredBar).x(function(e){return e.x},x).y(function(e){return e.y},i).attr("fill",function(e){return Z(e)});Q.push(m);for(var d=0;k>d;d++)m.addDataset(d===Q.length-1?a:new Plottable.Dataset([]));var c=D.axisConfigurations(),h=[];$.each(c,function(e,t){("day"===t[0].interval||"month"===t[0].interval||"year"===t[0].interval)&&h.push(t)}),D.axisConfigurations(h),A.push(m)}else{var p=(new Plottable.Plots.Line).x(function(e){return e.x},x).y(function(e){return e.y},T).attr("stroke",n.chart.lineColor).attr("stroke-width",r);p.addDataset(a),U.addDataset(a),A.push(p)}});var z=(new Plottable.Scales.Linear).domainMin(0).domainMax(1),B=(new Plottable.Plots.Line).x(function(e){return e.x},z).y(function(e){return e.y},T).attr("stroke","#dedede").attr("stroke-width",r);$.each(u,function(e,t){var a=y(e).thresholds;a&&B.addDataset(new Plottable.Dataset([{x:0,y:a.max},{x:1,y:a.max}]))}),A.push(B),A.push(U);var F=null,H=null;if(k>0){F=new Plottable.Scales.Color,H=new Plottable.Components.Legend(F);var R=[],Y=[];$.each(u,function(e,t){var a=y(e),n=a.seriesName,i=a.chart.barColor;n&&i&&(R.push(n),Y.push(i))}),F.domain(R),F.range(Y),H.maxEntriesPerRow(2),H.symbol(Plottable.SymbolFactories.square),H.xAlignment("right"),H.yAlignment("top"),A.push(H)}if(b.panZoom.enabled&&b.panZoom.showHint){var G=new Plottable.Components.Label("( Drag chart to pan, pinch or scroll to zoom )",0).padding(10).yAlignment("bottom").xAlignment("right").addClass("zoom-hint-label"),K=((new Plottable.Interactions.Click).attachTo(G).onClick(function(e){K()}),function(){G.addClass("hidden")});A.push(G)}var j=new Plottable.Components.Group(A),q=new Plottable.Components.Group([P,N]),W=[q,j],V=[null,D];$.each(L,function(e,t){W.push(new Plottable.Components.Group([t.axis,t.label])),V.push(null)}),h=new Plottable.Components.Table([W,V]),h.yAlignment("bottom"),C.attachTo(h);var X=_.chart.daysShownOnTimeline,J=X.min,ee=X.max,te=null,ae=null;if(b.panZoom.enabled&&(te=new Plottable.Interactions.PanZoom,te.addXScale(x),te.attachTo(j),ae=new Plottable.Interactions.PanZoom,ae.addXScale(x),ae.attachTo(D),J&&(te.minDomainExtent(x,J*i),ae.minDomainExtent(x,J*i)),ee&&(te.maxDomainExtent(x,ee*i),ae.maxDomainExtent(x,ee*i))),ee){var ne=[];$.each(u,function(e,t){$.each(t,function(e,t){ne.push(t.x)})});var ie=x.extentOfValues(ne),oe=ie[1].getTime()-ie[0].getTime(),re=ee*i;oe>re&&(ie[1]=new Date(ie[0].getTime()+re)),x.domain(ie)}var se=function(e){var t=_.chart.daysShownOnTimeline,a=t.min,n=t.max;a&&(e=Math.max(e,a)),n&&(e=Math.min(e,n));var o=x.domain(),r=[o[0],new Date(o[0].getTime()+e*i)];x.domain(r)},le=function(e){var t=_.chart.daysShownOnTimeline,a=t.min,n=t.max,o=x.domain();timeInDays=(o[1].getTime()-o[0].getTime())/i,timeInDays*=(100-e)/100,a&&(timeInDays=Math.max(timeInDays,a)),n&&(timeInDays=Math.min(timeInDays,n));var r=[o[0],new Date(o[0].getTime()+timeInDays*i)];x.domain(r)},ue=function(e){var t=x.domain();timeInDays=(t[1].getTime()-t[0].getTime())/i,timeInDays*=e/100;var a=[new Date(t[0].getTime()+timeInDays*i),new Date(t[1].getTime()+timeInDays*i)];x.domain(a)},me=function(){$(".time-button").removeClass("active")},de=null;if(b.toolbar.enabled){if(de=$("<div></div>"),de.addClass("omh-chart-toolbar"),de.attr("unselectable","on"),t.append(de),b.timespanButtons.enabled){var ce={"1wk":7,"1m":30,"3m":90,"6m":180};de.append($('<span class="time-buttons-label">Show: </span>')),$.each(ce,function(e,t){if(ee>=t&&t>=J){var a=$('<span class="time-button">'+e+"</span>");a.on("click",function(){me(),se(t),$(this).addClass("active")}),de.append(a)}})}if(b.zoomButtons.enabled){var he={"&#8722;":-20,"&#43;":20};de.append($('<span class="zoom-buttons-label"> Zoom: </span>')),$.each(he,function(e,t){var a=$('<span class="zoom-button">'+e+"</span>");a.on("click",function(){me(),le(t)}),de.append(a)})}if(b.navigation.enabled){var pe=$('<span class="previous-time-period-button">< prev</span>').click(function(){ue(-100)});de.prepend(pe);var ve=$('<span class="next-time-period-button">next ></span>').click(function(){ue(100)});de.append(ve)}}var fe=U.datasets(),be=fe&&fe.length>0;if(b.tooltips.enabled&&be){var ye=l,ge=null,_e=function(e){e.selection.style("opacity","1")},xe=function(e){e.selection.style("opacity",o)},Te=function(e,t){$.each(c[e][t],function(e,t){_e(t)})},we=function(e,t){$.each(c[e][t],function(e,t){xe(t)})},De=function(e){Se.show(e.datum,e.selection[0][0])},Pe=function(e){e&&(e.selection[0][0].getBoundingClientRect().left>l[0][0].getBoundingClientRect().left&&e.selection[0][0].getBoundingClientRect().right<l[0][0].getBoundingClientRect().right?De(e):Se.hide())},Ne=function(){if(ge)if(ge.datum.hasTooltip)Pe(ge);else{var e=d[ge.datum.groupName][ge.index],t=$(".d3-tip")[0].clientHeight;Pe(e.selection[0][0].getBoundingClientRect().top>l[0][0].getBoundingClientRect().top+t?e:ge)}},Ce=function(e){null!==ge?e.datum.body!==ge.datum.body&&(we(ge.datum.groupName,ge.index),ge=e,Te(ge.datum.groupName,e.index)):ge=e,null===e.datum},Ie=new Plottable.Interactions.Pointer;Ie.onPointerExit(function(e){Se.hide()}),Ie.onPointerEnter(Ne.bind(this));var Ae=function(e){var t;try{t=U.entityNearest(e)}catch(a){return}Ce(t),Ne()}.bind(this);Ie.onPointerMove(Ae),Ie.attachTo(U);var Ee=function(e,t){var a,n="value";if(S(e)&&(n+=" above-threshold"),"_systolic_blood_pressure_diastolic_blood_pressure"===e.groupName){var i=e.body.systolic_blood_pressure.value.toFixed(0),o=e.body.diastolic_blood_pressure.value.toFixed(0);a='<div class="'+n+'">'+i+"/"+o+"</div>"}else a="_heart_rate"===e.groupName?'<div class="'+n+'">'+e.y.toFixed(0)+"</div>":'<div class="'+n+'">'+e.y.toFixed(1)+"</div>";var r=b.tooltips.timeFormat;return a+='<div class="time">'+moment(e.x).format(r)+"</div>",a+='<div class="provider">'+e.provider+"</div>"},Se=d3.tip().attr("class","d3-tip").html(function(e){return'<div class="omh-tooltip">'+Ee(e,a)+"</div>"});ye.call(Se)}this.destroy=function(){Ie&&Ie.offPointerMove(Ae),Ie&&Ie.detachFrom(U),C.detachFrom(h),h.destroy(),Se&&Se.destroy(),Ne&&I.offWheel(Ne),Ne&&C.offDrag(Ne),de&&de.remove(),$.each(E,function(e,t){t()})},h.renderTo(l),$.each(U.entities(),function(e,t){var a=t.datum.groupName;d[a]||(d[a]=[]),t.datum.hasTooltip&&(d[a][t.index]=t),c[a]||(c[a]=[]),c[a][t.index]||(c[a][t.index]=[]),c[a][t.index].push(t)})},a});