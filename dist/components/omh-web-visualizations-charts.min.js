!function(e,t){var a="OMHWebVisualizations";e[a]=t(e,a)}(this,function(e,t){var a=e.hasOwnProperty(t)?e[t]:{};return a.Chart=function(e,t,a,n){var o=864e5,i=.5,r="1px",s="1px";t.jquery||(t=$(t)),n||(n={});var l=d3.select(t.find("svg")[0]);t.addClass("omh-chart-container");var m={},u=a.split(/\s*,\s*/),d={},c={},h=null,p={userInterface:{toolbar:{enabled:!0},timespanButtons:{enabled:!0},zoomButtons:{enabled:!0},navigation:{enabled:!0},tooltips:{enabled:!0,timeFormat:"M/D/YY, h:mma"},panZoom:{enabled:!0,showHint:!0}},measures:{body_weight:{valueKeyPath:"body.body_weight.value",range:{min:0,max:100},units:"kg",thresholds:{max:57}},heart_rate:{valueKeyPath:"body.heart_rate.value",range:{min:30,max:150},units:"bpm"},step_count:{valueKeyPath:"body.step_count",range:{min:0,max:1500},units:"Steps",seriesName:"Steps",chart:{type:"clustered_bar",barColor:"#eeeeee",daysShownOnTimeline:{min:7,max:90}}},minutes_moderate_activity:{valueKeyPath:"body.minutes_moderate_activity.value",range:{min:0,max:300},units:"Minutes",seriesName:"Minutes of moderate activity",chart:{type:"clustered_bar",daysShownOnTimeline:{min:7,max:90}}},systolic_blood_pressure:{valueKeyPath:"body.systolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:120}},diastolic_blood_pressure:{valueKeyPath:"body.diastolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:80}}}},v={range:{min:0,max:100},units:"Units",seriesName:"Series",chart:{type:"line",pointSize:9,lineColor:"#dedede",pointFillColor:"#4a90e2",pointStrokeColor:"#0066d6",aboveThesholdPointFillColor:"#e8ac4e",aboveThesholdPointStrokeColor:"#745628",barColor:"#4a90e2",daysShownOnTimeline:{min:1,max:1e3}}};this.getChartComponent=function(){return h},this.getD3Selection=function(){return l};var f=$.extend(!0,{},p,n);$.each(Object.keys(f.measures),function(e,t){f.measures[t]=$.extend(!0,{},v,f.measures[t])});var b=f.userInterface,y=function(e){return f.measures[e]},g=function(e,t){var a=t.split(".");return t&&a.length>0?g(e[a.shift()],a.join(".")):e};$.each(e,function(e,t){$.each(u,function(e,a){if(m.hasOwnProperty(a)||(m[a]=[]),t.body.hasOwnProperty(a)){var n=t.omhChartGroupName?t.omhChartGroupName:"",o=!n;n||($.each(u,function(e,a){t.body.hasOwnProperty(a)&&(n+="_"+a)}),t.omhChartGroupName=n);var i;if(t.body.effective_time_frame.date_time&&(i=new Date(t.body.effective_time_frame.date_time)),t.body.effective_time_frame.time_interval){var r,s=t.body.effective_time_frame.time_interval,l=s.start_date_time?new Date(s.start_date_time).getTime():null,d=s.end_date_time?new Date(s.end_date_time).getTime():null,c=s.start_date_time?moment(s.start_date_time):null,h=s.end_date_time?moment(s.end_date_time):null,p={ps:1e-9,ns:1e-6,us:.001,ms:1,sec:1e3,min:6e4,h:36e5,d:"d",wk:"w",Mo:"M",yr:"y"},v=s.duration.unit,f=s.duration.value,b=p[v];"string"!=typeof b?(r=f*b,l||(l=d-f),d||(d=l+f)):(l||(l=h.subtract(f,p[v]).valueOf()),d||(d=c.add(f,p[v]).valueOf()),r=d-l);var x=new Date(l);i=new Date(x.getFullYear(),x.getMonth(),x.getDate(),12,0,0,0)}var _=y(a).valueKeyPath,w=g(t,_);m[a].push({y:w,x:i,provider:t.header.acquisition_provenance.source_name,body:t.body,groupName:n,hasTooltip:o,measure:a})}})});var x=function(e){e.sort(function(e,t){return e.x.getTime()-t.x.getTime()});for(var t=0;t<e.length;t++)for(;t+1<e.length&&e[t+1].x.getTime()===e[t].x.getTime();)e[t].y+=e[t+1].y,e[t].accumulatedDataBodies||(e[t].accumulatedDataBodies=[e[t].body]),e[t].accumulatedDataBodies.push(e[t+1].body),e.splice(t+1,1)};m.minutes_moderate_activity&&x(m.minutes_moderate_activity),m.step_count&&x(m.step_count);var _=y(u[0]),w=new Plottable.Scales.Time,P=new Plottable.Scales.Linear,C=_.range;P.domainMin(C.min).domainMax(C.max);var D=new Plottable.Axes.Time(w,"bottom").margin(15).addClass("x-axis"),T=new Plottable.Axes.Numeric(P,"left"),S=new Plottable.Components.AxisLabel(_.units,"0").padding(5).xAlignment("right").yAlignment("top"),k=new Plottable.Interactions.Drag;k.onDrag(function(){Y&&Y(),$e&&$e()});var M=new Plottable.Dispatchers.Mouse(l[0][0]).onWheel(function(){$e&&$e(),de&&de(),Y&&Y()}),I=[],N=[],O=function(e){var t=y(e.measure).thresholds;return t&&e.y>t.max},A=function(e){var t=y(e.measure).chart;return O(e)?t.aboveThesholdPointFillColor:t.pointFillColor},B=function(e){var t=y(e.measure).chart;return O(e)?t.aboveThesholdPointStrokeColor:t.pointStrokeColor},F=function(e){return y(e.measure).chart.barColor},z=(new Plottable.Plots.Scatter).x(function(e){return e.x},w).y(function(e){return e.y},P).size(function(e){return y(e.measure).chart.pointSize}).attr("fill",function(e){return A(e)}).attr("opacity",i).attr("stroke-width",s).attr("stroke",function(e){return B(e)}),L=[],E=0,K=[];$.each(m,function(e,t){"clustered_bar"===_.chart.type&&E++}),$.each(m,function(e,t){var a=new Plottable.Dataset(t),n=y(e);if(a.measure=e,"clustered_bar"===n.chart.type){var o=P;if(L.length>0){var i=n.range,s=n.units;o=(new Plottable.Scales.Linear).domainMin(i.min).domainMax(i.max);var l=new Plottable.Axes.Numeric(o,"right"),m=new Plottable.Components.AxisLabel(s,"0").padding(5).xAlignment("left").yAlignment("top");K.push([l,m])}var u=(new Plottable.Plots.ClusteredBar).x(function(e){return e.x},w).y(function(e){return e.y},o).attr("fill",function(e){return F(e)});L.push(u);for(var d=0;E>d;d++)u.addDataset(d===L.length-1?a:new Plottable.Dataset([]));var c=D.axisConfigurations(),h=[];$.each(c,function(e,t){("day"===t[0].interval||"month"===t[0].interval||"year"===t[0].interval)&&h.push(t)}),D.axisConfigurations(h),I.push(u)}else{var p=(new Plottable.Plots.Line).x(function(e){return e.x},w).y(function(e){return e.y},P).attr("stroke",n.chart.lineColor).attr("stroke-width",r);p.addDataset(a),z.addDataset(a),I.push(p)}});var R=(new Plottable.Scales.Linear).domainMin(0).domainMax(1),Z=(new Plottable.Plots.Line).x(function(e){return e.x},R).y(function(e){return e.y},P).attr("stroke","#dedede").attr("stroke-width",r);if($.each(m,function(e,t){var a=y(e).thresholds;a&&Z.addDataset(new Plottable.Dataset([{x:0,y:a.max},{x:1,y:a.max}]))}),I.push(Z),I.push(z),E>0){var G=new Plottable.Scales.Color,H=new Plottable.Components.Legend(G),j=[],q=[];$.each(m,function(e,t){var a=y(e),n=a.seriesName,o=a.chart.barColor;n&&o&&(j.push(n),q.push(o))}),G.domain(j),G.range(q),H.maxEntriesPerRow(2),H.symbol(Plottable.SymbolFactories.square),H.xAlignment("right"),H.yAlignment("top"),I.push(H)}if(b.panZoom.enabled&&b.panZoom.showHint){var W=new Plottable.Components.Label("( Drag chart to pan, pinch or scroll to zoom )",0).padding(10).yAlignment("bottom").xAlignment("right").addClass("zoom-hint-label"),Y=((new Plottable.Interactions.Click).attachTo(W).onClick(function(e){Y()}),function(){W.addClass("hidden")});I.push(W)}var V=new Plottable.Components.Group(I),X=new Plottable.Components.Group([T,S]),U=[X,V],J=[null,D];$.each(K,function(e,t){U.push(new Plottable.Components.Group(t)),J.push(null)}),h=new Plottable.Components.Table([U,J]),h.yAlignment("bottom"),k.attachTo(h);var Q=_.chart.daysShownOnTimeline,ee=Q.min,te=Q.max;if(b.panZoom.enabled){var ae=new Plottable.Interactions.PanZoom;ae.addXScale(w),ae.attachTo(V);var ne=new Plottable.Interactions.PanZoom;ne.addXScale(w),ne.attachTo(D),ee&&(ae.minDomainExtent(w,ee*o),ne.minDomainExtent(w,ee*o)),te&&(ae.maxDomainExtent(w,te*o),ne.maxDomainExtent(w,te*o))}if(te){var oe=[];$.each(m,function(e,t){$.each(t,function(e,t){oe.push(t.x)})});var ie=w.extentOfValues(oe),re=ie[1].getTime()-ie[0].getTime(),se=te*o;re>se&&(ie[1]=new Date(ie[0].getTime()+se)),w.domain(ie)}var le=function(e){var t=_.chart.daysShownOnTimeline,a=t.min,n=t.max;a&&(e=Math.max(e,a)),n&&(e=Math.min(e,n));var i=w.domain(),r=[i[0],new Date(i[0].getTime()+e*o)];w.domain(r)},me=function(e){var t=_.chart.daysShownOnTimeline,a=t.min,n=t.max,i=w.domain();timeInDays=(i[1].getTime()-i[0].getTime())/o,timeInDays*=(100-e)/100,a&&(timeInDays=Math.max(timeInDays,a)),n&&(timeInDays=Math.min(timeInDays,n));var r=[i[0],new Date(i[0].getTime()+timeInDays*o)];w.domain(r)},ue=function(e){var t=w.domain();timeInDays=(t[1].getTime()-t[0].getTime())/o,timeInDays*=e/100;var a=[new Date(t[0].getTime()+timeInDays*o),new Date(t[1].getTime()+timeInDays*o)];w.domain(a)},de=function(){$(".time-button").removeClass("active")};if(b.toolbar.enabled){var ce=$("<div></div>");if(ce.addClass("omh-chart-toolbar"),ce.attr("unselectable","on"),t.append(ce),b.timespanButtons.enabled){var he={"1wk":7,"1m":30,"3m":90,"6m":180};ce.append($('<span class="time-buttons-label">Show: </span>')),$.each(he,function(e,t){if(te>=t&&t>=ee){var a=$('<span class="time-button">'+e+"</span>");a.on("click",function(){de(),le(t),$(this).addClass("active")}),ce.append(a)}})}if(b.zoomButtons.enabled){var pe={"&#8722;":-20,"&#43;":20};ce.append($('<span class="zoom-buttons-label"> Zoom: </span>')),$.each(pe,function(e,t){var a=$('<span class="zoom-button">'+e+"</span>");a.on("click",function(){de(),me(t)}),ce.append(a)})}if(b.navigation.enabled){var ve=$('<span class="previous-time-period-button">< prev</span>').click(function(){ue(-100)});ce.prepend(ve);var fe=$('<span class="next-time-period-button">next ></span>').click(function(){ue(100)});ce.append(fe)}}var be=z.datasets(),ye=be&&be.length>0;if(b.tooltips.enabled&&ye){var ge=l,xe=null,_e=function(e){e.selection.style("opacity","1")},we=function(e){e.selection.style("opacity",i)},Pe=function(e,t){$.each(c[e][t],function(e,t){_e(t)})},Ce=function(e,t){$.each(c[e][t],function(e,t){we(t)})},De=function(e){Ne.show(e.datum,e.selection[0][0])},Te=function(e){e&&(e.selection[0][0].getBoundingClientRect().left>l[0][0].getBoundingClientRect().left&&e.selection[0][0].getBoundingClientRect().right<l[0][0].getBoundingClientRect().right?De(e):Ne.hide())},$e=function(){if(xe)if(xe.datum.hasTooltip)Te(xe);else{var e=d[xe.datum.groupName][xe.index],t=$(".d3-tip")[0].clientHeight;Te(e.selection[0][0].getBoundingClientRect().top>l[0][0].getBoundingClientRect().top+t?e:xe)}},Se=function(e){null!==xe?e.datum.body!==xe.datum.body&&(Ce(xe.datum.groupName,xe.index),xe=e,Pe(xe.datum.groupName,e.index)):xe=e,null===e.datum},ke=new Plottable.Interactions.Pointer;ke.onPointerExit(function(e){Ne.hide()}),ke.onPointerEnter($e.bind(this));var Me=function(e){var t;try{t=z.entityNearest(e)}catch(a){return}Se(t),$e()}.bind(this);ke.onPointerMove(Me),ke.attachTo(z);var Ie=function(e,t){var a,n="value";if(O(e)&&(n+=" above-threshold"),"_systolic_blood_pressure_diastolic_blood_pressure"===e.groupName){var o=e.body.systolic_blood_pressure.value.toFixed(0),i=e.body.diastolic_blood_pressure.value.toFixed(0);a='<div class="'+n+'">'+o+"/"+i+"</div>"}else a="_heart_rate"===e.groupName?'<div class="'+n+'">'+e.y.toFixed(0)+"</div>":'<div class="'+n+'">'+e.y.toFixed(1)+"</div>";var r=b.tooltips.timeFormat;return a+='<div class="time">'+moment(e.x).format(r)+"</div>",a+='<div class="provider">'+e.provider+"</div>"},Ne=d3.tip().attr("class","d3-tip").html(function(e){return'<div class="omh-tooltip">'+Ie(e,a)+"</div>"});ge.call(Ne)}this.destroy=function(){ke&&ke.offPointerMove(Me),ke&&ke.detachFrom(z),k.detachFrom(h),h.destroy(),Ne&&Ne.destroy(),$e&&M.offWheel($e),$e&&k.offDrag($e),ce&&ce.remove(),$.each(N,function(e,t){t()})},h.renderTo(l),$.each(z.entities(),function(e,t){var a=t.datum.groupName;d[a]||(d[a]=[]),t.datum.hasTooltip&&(d[a][t.index]=t),c[a]||(c[a]=[]),c[a][t.index]||(c[a][t.index]=[]),c[a][t.index].push(t)})},a});