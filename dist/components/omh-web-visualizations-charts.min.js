!function(e,t){var a="OMHWebVisualizations";e[a]=t(e,a)}(this,function(e,t){var a=e.hasOwnProperty(t)?e[t]:{};return a.Chart=function(e,t,a,n){var i=864e5,o=.5,r="1px",s="1px";this.QUANTIZE_YEAR=6,this.QUANTIZE_MONTH=5,this.QUANTIZE_DAY=4,this.QUANTIZE_HOUR=3,this.QUANTIZE_MINUTE=2,this.QUANTIZE_SECOND=1,this.QUANTIZE_MILLISECOND=0,this.QUANTIZE_NONE=-1,t.jquery||(t=$(t)),n||(n={});var l=null;t.addClass("omh-chart-container");var u=null,m=a.split(/\s*,\s*/),c={},d={},h=null,p=null,v={userInterface:{toolbar:{enabled:!0},timespanButtons:{enabled:!0},zoomButtons:{enabled:!0},navigation:{enabled:!0},tooltips:{enabled:!0,timeFormat:"M/D/YY, h:mma"},panZoom:{enabled:!0,showHint:!0}},measures:{body_weight:{valueKeyPath:"body.body_weight.value",range:{min:0,max:100},units:"kg",thresholds:{max:57}},heart_rate:{valueKeyPath:"body.heart_rate.value",range:{min:30,max:150},units:"bpm"},step_count:{valueKeyPath:"body.step_count",range:{min:0,max:1500},units:"Steps",seriesName:"Steps",timeQuantizationLevel:this.QUANTIZE_DAY,chart:{type:"clustered_bar",barColor:"#eeeeee",daysShownOnTimeline:{min:7,max:90}}},minutes_moderate_activity:{valueKeyPath:"body.minutes_moderate_activity.value",range:{min:0,max:300},units:"Minutes",seriesName:"Minutes of moderate activity",timeQuantizationLevel:this.QUANTIZE_DAY,chart:{type:"clustered_bar",daysShownOnTimeline:{min:7,max:90}}},systolic_blood_pressure:{valueKeyPath:"body.systolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:120}},diastolic_blood_pressure:{valueKeyPath:"body.diastolic_blood_pressure.value",range:{min:30,max:200},units:"mmHg",thresholds:{max:80}}}},f={range:{min:0,max:100},units:"Units",seriesName:"Series",timeQuantizationLevel:this.QUANTIZE_NONE,chart:{type:"line",pointSize:9,lineColor:"#dedede",pointFillColor:"#4a90e2",pointStrokeColor:"#0066d6",aboveThesholdPointFillColor:"#e8ac4e",aboveThesholdPointStrokeColor:"#745628",barColor:"#4a90e2",daysShownOnTimeline:{min:1,max:1e3}}};this.getComponents=function(){var e={};e[m[0]]=D;var t={};t[m[0]]=N;var a={};a[m[0]]=C;var n={};n[m[0]]=T;var i={};i[m[0]]=P;var o={};return o[m[0]]=R,$.each(B,function(n,i){e[i.measure]=i.scale,t[i.measure]=i.axis,a[i.measure]=i.label}),{xScales:n,yScales:e,colorScales:o,gridlines:null,legends:[Y],xAxes:i,yAxes:t,plots:S,yLabels:a,table:h,tooltip:$e,toolbar:he,panZoomInteractions:{plotGroup:ne,xAxis:ie}}},this.getD3Selection=function(){return l};var b=$.extend(!0,{},v,n);$.each(Object.keys(b.measures),function(e,t){b.measures[t]=$.extend(!0,{},f,b.measures[t])});var y=b.userInterface,g=function(e){return b.measures[e]},_=function(e,t){var a=t.split(".");return t&&a.length>0?_(e[a.shift()],a.join(".")):e};this.getIntervalDisplayDate=function(e,t,a){var n,i=e.body.effective_time_frame.time_interval,o=i.start_date_time?new Date(i.start_date_time).getTime():null,r=i.end_date_time?new Date(i.end_date_time).getTime():null,s=i.start_date_time?t(i.start_date_time):null,l=i.end_date_time?t(i.end_date_time):null,u={ps:1e-9,ns:1e-6,us:.001,ms:1,sec:1e3,min:6e4,h:36e5,d:"d",wk:"w",Mo:"M",yr:"y"},m=i.duration.unit,c=i.duration.value,d=u[m];"string"!=typeof d?(n=c*d,o||(o=r-c),r||(r=o+c)):(o||(o=l.subtract(c,u[m]).valueOf()),r||(r=s.add(c,u[m]).valueOf()),n=r-o);var h=new Date(o),p=a<=this.QUANTIZE_MONTH?h.getMonth():6,v=a<=this.QUANTIZE_DAY?h.getDate():a===this.QUANTIZE_MONTH?15:1,f=a<=this.QUANTIZE_HOUR?h.getHours():a===this.QUANTIZE_DAY?12:0,b=a<=this.QUANTIZE_MINUTE?h.getMinutes():a===this.QUANTIZE_HOUR?30:0,y=a<=this.QUANTIZE_SECOND?h.getSeconds():a===this.QUANTIZE_MINUTE?30:0,g=a<=this.QUANTIZE_MILLISECOND?h.getMilliseconds():a===this.QUANTIZE_SECOND?500:0,_=new Date(h.getFullYear(),p,v,f,b,y,g);return _},this.parseOmhData=function(e,t,a){var n={},i=this;return $.each(e,function(e,o){$.each(t,function(e,r){if(n.hasOwnProperty(r)||(n[r]=[]),o.body.hasOwnProperty(r)){var s=o.omhChartGroupName?o.omhChartGroupName:"",l=!s;s||($.each(t,function(e,t){o.body.hasOwnProperty(t)&&(s+="_"+t)}),o.omhChartGroupName=s);var u;if(o.body.effective_time_frame.date_time&&(u=new Date(o.body.effective_time_frame.date_time)),o.body.effective_time_frame.time_interval){var m=g(r).timeQuantizationLevel;u=i.getIntervalDisplayDate(o,a,m)}var c=g(r).valueKeyPath,d=_(o,c);n[r].push({y:d,x:u,provider:o.header.acquisition_provenance.source_name,body:o.body,groupName:s,hasTooltip:l,measure:r})}})}),n},u=this.parseOmhData(e,m,moment),this.consolidateData=function(e){e.sort(function(e,t){return e.x.getTime()-t.x.getTime()});for(var t=0;t<e.length;t++)for(;t+1<e.length&&e[t+1].x.getTime()===e[t].x.getTime();)e[t].y+=e[t+1].y,e[t].accumulatedDataBodies||(e[t].accumulatedDataBodies=[e[t].body]),e[t].accumulatedDataBodies.push(e[t+1].body),e.splice(t+1,1)},u.minutes_moderate_activity&&this.consolidateData(u.minutes_moderate_activity),u.step_count&&this.consolidateData(u.step_count);var x=g(m[0]),T=new Plottable.Scales.Time,D=new Plottable.Scales.Linear,w=x.range;D.domainMin(w.min).domainMax(w.max);var P=new Plottable.Axes.Time(T,"bottom").margin(15).addClass("x-axis"),N=new Plottable.Axes.Numeric(D,"left"),C=new Plottable.Components.AxisLabel(x.units,"0").padding(5).xAlignment("right").yAlignment("top"),I=new Plottable.Interactions.Drag,A=function(){$e&&j&&j(),Ce&&Ce()};I.onDrag(A);var E=function(){Ce&&Ce(),de&&de(),j&&j()},S=[],M=[],O=function(e){var t=g(e.measure).thresholds;return t&&e.y>t.max},Z=function(e){var t=g(e.measure).chart;return O(e)?t.aboveThesholdPointFillColor:t.pointFillColor},U=function(e){var t=g(e.measure).chart;return O(e)?t.aboveThesholdPointStrokeColor:t.pointStrokeColor},Q=function(e){return g(e.measure).chart.barColor},k=(new Plottable.Plots.Scatter).x(function(e){return e.x},T).y(function(e){return e.y},D).size(function(e){return g(e.measure).chart.pointSize}).attr("fill",function(e){return Z(e)}).attr("opacity",o).attr("stroke-width",s).attr("stroke",function(e){return U(e)}),L=[],z=0,B=[];$.each(u,function(e,t){"clustered_bar"===x.chart.type&&z++}),$.each(u,function(e,t){var a=new Plottable.Dataset(t),n=g(e);if(a.measure=e,"clustered_bar"===n.chart.type){var i=D;if(L.length>0){var o=n.range,s=n.units;i=(new Plottable.Scales.Linear).domainMin(o.min).domainMax(o.max);var l=new Plottable.Axes.Numeric(i,"right"),u=new Plottable.Components.AxisLabel(s,"0").padding(5).xAlignment("left").yAlignment("top");B.push({measure:e,axis:l,label:u,scale:i})}var m=(new Plottable.Plots.ClusteredBar).x(function(e){return e.x},T).y(function(e){return e.y},i).attr("fill",function(e){return Q(e)});L.push(m);for(var c=0;z>c;c++)m.addDataset(c===L.length-1?a:new Plottable.Dataset([]));var d=P.axisConfigurations(),h=[];$.each(d,function(e,t){("day"===t[0].interval||"month"===t[0].interval||"year"===t[0].interval)&&h.push(t)}),P.axisConfigurations(h),S.push(m)}else{var p=(new Plottable.Plots.Line).x(function(e){return e.x},T).y(function(e){return e.y},D).attr("stroke",n.chart.lineColor).attr("stroke-width",r);p.addDataset(a),k.addDataset(a),S.push(p)}});var F=(new Plottable.Scales.Linear).domainMin(0).domainMax(1),H=(new Plottable.Plots.Line).x(function(e){return e.x},F).y(function(e){return e.y},D).attr("stroke","#dedede").attr("stroke-width",r);$.each(u,function(e,t){var a=g(e).thresholds;a&&H.addDataset(new Plottable.Dataset([{x:0,y:a.max},{x:1,y:a.max}]))}),S.push(H),S.push(k);var R=null,Y=null;if(z>0){R=new Plottable.Scales.Color,Y=new Plottable.Components.Legend(R);var G=[],K=[];$.each(u,function(e,t){var a=g(e),n=a.seriesName,i=a.chart.barColor;n&&i&&(G.push(n),K.push(i))}),R.domain(G),R.range(K),Y.maxEntriesPerRow(2),Y.symbol(Plottable.SymbolFactories.square),Y.xAlignment("right"),Y.yAlignment("top"),S.push(Y)}if(y.panZoom.enabled&&y.panZoom.showHint){var W=new Plottable.Components.Label("( Drag chart to pan, pinch or scroll to zoom )",0).padding(10).yAlignment("bottom").xAlignment("right").addClass("zoom-hint-label"),j=((new Plottable.Interactions.Click).attachTo(W).onClick(function(e){j()}),function(){W.addClass("hidden")});S.push(W)}var q=new Plottable.Components.Group(S),V=new Plottable.Components.Group([N,C]),X=[V,q],J=[null,P];$.each(B,function(e,t){X.push(new Plottable.Components.Group([t.axis,t.label])),J.push(null)}),h=new Plottable.Components.Table([X,J]),h.yAlignment("bottom"),I.attachTo(h);var ee=x.chart.daysShownOnTimeline,te=ee.min,ae=ee.max,ne=null,ie=null;if(y.panZoom.enabled&&(ne=new Plottable.Interactions.PanZoom,ne.addXScale(T),ne.attachTo(q),ie=new Plottable.Interactions.PanZoom,ie.addXScale(T),ie.attachTo(P),te&&(ne.minDomainExtent(T,te*i),ie.minDomainExtent(T,te*i)),ae&&(ne.maxDomainExtent(T,ae*i),ie.maxDomainExtent(T,ae*i))),ae){var oe=[];$.each(u,function(e,t){$.each(t,function(e,t){oe.push(t.x)})});var re=T.extentOfValues(oe),se=re[1].getTime()-re[0].getTime(),le=ae*i;se>le&&(re[1]=new Date(re[0].getTime()+le)),T.domain(re)}var ue=function(e){var t=x.chart.daysShownOnTimeline,a=t.min,n=t.max;a&&(e=Math.max(e,a)),n&&(e=Math.min(e,n));var o=T.domain(),r=[o[0],new Date(o[0].getTime()+e*i)];T.domain(r)},me=function(e){var t=x.chart.daysShownOnTimeline,a=t.min,n=t.max,o=T.domain();timeInDays=(o[1].getTime()-o[0].getTime())/i,timeInDays*=(100-e)/100,a&&(timeInDays=Math.max(timeInDays,a)),n&&(timeInDays=Math.min(timeInDays,n));var r=[o[0],new Date(o[0].getTime()+timeInDays*i)];T.domain(r)},ce=function(e){var t=T.domain();timeInDays=(t[1].getTime()-t[0].getTime())/i,timeInDays*=e/100;var a=[new Date(t[0].getTime()+timeInDays*i),new Date(t[1].getTime()+timeInDays*i)];T.domain(a)},de=function(){$(".time-button").removeClass("active")},he=null;if(y.toolbar.enabled){if(he=$("<div></div>"),he.addClass("omh-chart-toolbar"),he.attr("unselectable","on"),t.append(he),y.timespanButtons.enabled){var pe={"1wk":7,"1m":30,"3m":90,"6m":180};he.append($('<span class="time-buttons-label">Show: </span>')),$.each(pe,function(e,t){if(ae>=t&&t>=te){var a=$('<span class="time-button">'+e+"</span>");a.on("click",function(){de(),ue(t),$(this).addClass("active")}),he.append(a)}})}if(y.zoomButtons.enabled){var ve={"&#8722;":-20,"&#43;":20};he.append($('<span class="zoom-buttons-label"> Zoom: </span>')),$.each(ve,function(e,t){var a=$('<span class="zoom-button">'+e+"</span>");a.on("click",function(){de(),me(t)}),he.append(a)})}if(y.navigation.enabled){var fe=$('<span class="previous-time-period-button">< prev</span>').click(function(){ce(-100)});he.prepend(fe);var be=$('<span class="next-time-period-button">next ></span>').click(function(){ce(100)});he.append(be)}}var ye=k.datasets(),ge=ye&&ye.length>0;if(y.tooltips.enabled&&ge){var _e=null,xe=function(e){e.selection.style("opacity","1")},Te=function(e){e.selection.style("opacity",o)},De=function(e,t){$.each(d[e][t],function(e,t){xe(t)})},we=function(e,t){$.each(d[e][t],function(e,t){Te(t)})},Pe=function(e){$e.show(e.datum,e.selection[0][0])},Ne=function(e){e&&l&&(e.selection[0][0].getBoundingClientRect().left>l[0][0].getBoundingClientRect().left&&e.selection[0][0].getBoundingClientRect().right<l[0][0].getBoundingClientRect().right?Pe(e):$e.hide())},Ce=function(){if(_e&&l)if(_e.datum.hasTooltip)Ne(_e);else{var e=c[_e.datum.groupName][_e.index],t=$(".d3-tip")[0].clientHeight;Ne(e.selection[0][0].getBoundingClientRect().top>l[0][0].getBoundingClientRect().top+t?e:_e)}},Ie=function(e){null!==_e?e.datum.body!==_e.datum.body&&(we(_e.datum.groupName,_e.index),_e=e,De(_e.datum.groupName,e.index)):_e=e,null===e.datum},Ae=new Plottable.Interactions.Pointer;Ae.onPointerExit(function(e){$e.hide()}),Ae.onPointerEnter(Ce.bind(this));var Ee=function(e){var t;try{t=k.entityNearest(e)}catch(a){return}Ie(t),Ce()}.bind(this);Ae.onPointerMove(Ee),Ae.attachTo(k);var Se=function(e,t){var a,n="value";if(O(e)&&(n+=" above-threshold"),"_systolic_blood_pressure_diastolic_blood_pressure"===e.groupName){var i=e.body.systolic_blood_pressure.value.toFixed(0),o=e.body.diastolic_blood_pressure.value.toFixed(0);a='<div class="'+n+'">'+i+"/"+o+"</div>"}else a="_heart_rate"===e.groupName?'<div class="'+n+'">'+e.y.toFixed(0)+"</div>":'<div class="'+n+'">'+e.y.toFixed(1)+"</div>";var r=y.tooltips.timeFormat;return a+='<div class="time">'+moment(e.x).format(r)+"</div>",a+='<div class="provider">'+e.provider+"</div>"},$e=d3.tip().attr("class","d3-tip").html(function(e){return'<div class="omh-tooltip">'+Se(e,a)+"</div>"})}this.destroy=function(){Ae&&Ae.offPointerMove(Ee),Ae&&Ae.detachFrom(k),I.detachFrom(h),h.destroy(),$e&&$e.destroy(),p&&p.offWheel(E),Ce&&I.offDrag(Ce),he&&he.remove(),$.each(M,function(e,t){t()})},this.renderTo=function(e){l=d3.select(e),$e&&l.call($e),p&&p.offWheel(E),p=new Plottable.Dispatchers.Mouse.getDispatcher(l[0][0]).onWheel(E),h.renderTo(l),c={},d={},$.each(k.entities(),function(e,t){var a=t.datum.groupName;c[a]||(c[a]=[]),t.datum.hasTooltip&&(c[a][t.index]=t),d[a]||(d[a]=[]),d[a][t.index]||(d[a][t.index]=[]),d[a][t.index].push(t)})}},a});